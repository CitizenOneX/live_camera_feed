local a={streaming=false,quality=50,auto_exp_gain_times=0,metering_mode="SPOT",exposure=0,shutter_kp=0.1,shutter_limit=6000,gain_kp=1.0,gain_limit=248.0}local b={10,25,50,100}local c={"SPOT","CENTER_WEIGHTED","AVERAGE"}BATTERY_LEVEL_FLAG="\x0c"NON_FINAL_CHUNK_FLAG="\x07"FINAL_CHUNK_FLAG="\x08"START_STREAM_FLAG=0x0a;STOP_STREAM_FLAG=0x0b;CAMERA_SETTINGS_FLAG=0x0d;function data_handler(d)if string.byte(d,1)==START_STREAM_FLAG then a.streaming=true elseif string.byte(d,1)==STOP_STREAM_FLAG then a.streaming=false elseif string.byte(d,1)==CAMERA_SETTINGS_FLAG then a.quality=b[string.byte(d,2)+1]a.auto_exp_gain_times=string.byte(d,3)a.metering_mode=c[string.byte(d,4)+1]a.exposure=(string.byte(d,5)-128)/64.0;a.shutter_kp=string.byte(d,6)/10.0;a.shutter_limit=string.byte(d,7)<<8|string.byte(d,8)a.gain_kp=string.byte(d,9)/10.0;a.gain_limit=string.byte(d,10)end end;function show_streaming()frame.display.text("Streaming",1,1)frame.display.show()frame.sleep(0.04)end;function clear_display()frame.display.text(" ",1,1)frame.display.show()frame.sleep(0.04)end;function send_batt_if_elapsed(e,f)local g=frame.time.utc()if e==0 or g-e>f then pcall(frame.bluetooth.send,BATTERY_LEVEL_FLAG..string.char(math.floor(frame.battery_level())))return g else return e end end;function app_loop()local h=frame.bluetooth.max_length()-4;local i=0;local j=true;local k=true;local l=true;local m={}while true do if a.streaming then if j then show_streaming()j=false end;rc,err=pcall(function()if k and l then k=false;l=false;frame.camera.capture{quality_factor=a.quality}elseif not l and m[1]~=nil then local n=1;for o,p in pairs(m)do pcall(frame.bluetooth.send,NON_FINAL_CHUNK_FLAG..p)if n%8==0 then frame.camera.auto{metering=a.metering_mode,exposure=a.exposure,shutter_kp=a.shutter_kp,shutter_limit=a.shutter_limit,gain_kp=a.gain_kp,gain_limit=a.gain_limit}frame.sleep(0.0075)else frame.sleep(0.0125)end;n=n+1 end;pcall(frame.bluetooth.send,FINAL_CHUNK_FLAG)l=true;for o,p in pairs(m)do m[o]=nil end elseif l and not k then while true do local d=frame.camera.read(h)if d==nil then break end;table.insert(m,d)end;k=true else l=true end end)if rc==false then print(err)clear_display()break end else j=true;frame.sleep(0.1)end;i=send_batt_if_elapsed(i,30)end end;frame.bluetooth.receive_callback(data_handler)app_loop()